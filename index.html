<!doctype html>
<html lang="uz">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Namoz Vaqtlari ‚Äî IMBA v2 (Asr 16:11)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg1:#041226; --bg2:#042b3a; --card:rgba(255,255,255,0.03);
    --text:#e7f6fb; --muted:#9fb6c6; --accent:#00d4b6;
  }
  [data-theme="light"]{
    --bg1:#f7fbff; --bg2:#eef6ff; --card:#ffffff; --text:#06232b; --muted:#4b6b78; --accent:#0066cc;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;color:var(--text);background:linear-gradient(180deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased}
  body{display:flex;align-items:center;justify-content:center;padding:28px;overflow:hidden}
  .bg{position:fixed;inset:0;z-index:0;pointer-events:none;overflow:hidden}
  .wave{position:absolute;left:-25%;width:150%;height:75%;background:linear-gradient(90deg, rgba(0,128,160,0.12), rgba(0,64,120,0.12));bottom:-20%;transform:rotate(-6deg);filter:blur(34px);animation:wave1 16s ease-in-out infinite;opacity:0.95}
  .wave.w2{bottom:-40%;animation:wave2 20s ease-in-out infinite;opacity:0.7;filter:blur(44px);transform:rotate(3deg)}
  @keyframes wave1{0%{transform:translateX(-6%) rotate(-6deg)}50%{transform:translateX(6%) rotate(-6deg)}100%{transform:translateX(-6%) rotate(-6deg)}}
  @keyframes wave2{0%{transform:translateX(6%) rotate(3deg)}50%{transform:translateX(-6%) rotate(3deg)}100%{transform:translateX(6%) rotate(3deg)}}

  .container{position:relative;z-index:2;width:100%;max-width:980px}
  .card{background:var(--card);backdrop-filter: blur(8px);border-radius:16px;padding:20px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 18px 40px rgba(0,0,0,0.5)}
  header{display:flex;align-items:flex-start;justify-content:space-between;gap:12px}
  h1{margin:0;font-size:22px}
  .subtitle{font-size:13px;color:var(--muted);margin-top:6px}
  .actions{display:flex;gap:8px;align-items:center}
  .btn{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text);cursor:pointer}
  .btn.primary{background:var(--accent);color:#042;box-shadow:0 8px 20px rgba(0,212,182,0.12);border:none}
  .small{font-size:13px;padding:6px 10px;border-radius:8px}

  .main-grid{display:grid;grid-template-columns:1fr 360px;gap:14px;margin-top:18px}
  .left{display:flex;flex-direction:column;gap:12px}
  .right{display:flex;flex-direction:column;gap:12px}

  .loc{font-weight:700;color:var(--accent)}
  .hint{font-size:13px;color:var(--muted)}
  .times-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
  .prayer-card{border-radius:12px;padding:14px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));display:flex;align-items:center;gap:12px;border:1px solid rgba(255,255,255,0.02);transition:transform .25s}
  .prayer-card:hover{transform:translateY(-6px)}
  .icon{width:46px;height:46px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));font-weight:700}
  .pname{font-size:13px;color:var(--muted)}
  .ptime{font-size:18px;font-weight:800}

  .next-panel{padding:14px;border-radius:12px;background:linear-gradient(90deg, rgba(0,0,0,0.04), rgba(0,0,0,0.02));display:flex;justify-content:space-between;align-items:center;gap:12px;border:1px solid rgba(255,255,255,0.02)}
  .next-left{display:flex;flex-direction:column;gap:6px}
  .next-title{font-size:13px;color:var(--muted)}
  .countdown{font-size:20px;font-weight:900;color:var(--accent)}

  .clock{font-size:13px;color:var(--muted)}
  .controls-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  .right .card-small{padding:12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.02)}
  .toggle{display:flex;align-items:center;gap:8px}
  .switch{width:46px;height:26px;background:rgba(255,255,255,0.06);border-radius:20px;position:relative;cursor:pointer}
  .knob{width:20px;height:20px;background:#fff;border-radius:50%;position:absolute;left:4px;top:3px;transition:left .22s}
  .switch.on{background:var(--accent)}
  .switch.on .knob{left:22px}

  footer{margin-top:14px;color:var(--muted);text-align:center;font-size:13px}

  @media(max-width:980px){
    .main-grid{grid-template-columns:1fr}
    .right{order:2}
  }
</style>
</head>
<body>
  <div class="bg" aria-hidden="true">
    <div class="wave"></div>
    <div class="wave w2"></div>
  </div>

  <div class="container">
    <div class="card" id="appCard">
      <header>
        <div>
          <h1>Namoz vaqtlari ‚Äî IMBA v2</h1>
          <div class="subtitle">Lotin yozuvida ¬∑ GPS + Toshkent fallback ¬∑ Asr doim 16:11</div>
        </div>
        <div class="actions">
          <div class="controls-row">
            <button class="btn primary" id="gpsBtn">üìç GPS orqali</button>
            <button class="btn small" id="playAzanBtn">üîä Azonni sinash</button>
            <div class="toggle" title="Tema">
              <div id="themeToggle" class="switch" role="switch"><div class="knob"></div></div>
            </div>
          </div>
        </div>
      </header>

      <div class="main-grid">
        <div class="left">
          <div>
            <div class="loc" id="locText">Joylashuv: aniqlanmadi</div>
            <div class="hint" id="hintText">GPS orqali aniqlash uchun yuqoridagi tugmani bosing. Agar GPS ishlamasa ‚Äî avtomatik Toshkent fallback ishlaydi.</div>
          </div>

          <div class="times-grid" id="timesGrid" aria-live="polite">
            <!-- cards -->
          </div>

          <div class="next-panel" id="nextPanel" style="display:none">
            <div class="next-left">
              <div class="next-title" id="nextLabel">Keyingi namoz</div>
              <div class="clock" id="nextTimeLabel">‚Äî</div>
            </div>
            <div class="countdown" id="countdown">‚Äî soat ‚Äî daqiqa ‚Äî soniya</div>
          </div>
        </div>

        <div class="right">
          <div class="card-small">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="hint">Bugun</div>
                <div id="dateLabel" class="ptime" style="font-size:15px;color:var(--text)"></div>
              </div>
              <div style="text-align:right">
                <div class="hint">Soat</div>
                <div id="clockNow" class="ptime" style="font-size:15px;color:var(--text)"></div>
              </div>
            </div>
          </div>

          <div class="card-small" style="margin-top:10px">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div>
                <div class="hint">Azonni avtomatik chalish</div>
                <div style="font-size:13px;color:var(--muted)">Brauzer ruxsatiga bog‚Äòliq</div>
              </div>
              <div>
                <div id="azanSwitch" class="switch" role="switch"><div class="knob"></div></div>
              </div>
            </div>
            <div style="margin-top:8px" class="hint">Agar xohlasangiz, azonni qo‚Äòlda ham chalishingiz mumkin.</div>
          </div>

          <div class="card-small" style="margin-top:10px">
            <div>
              <div class="hint">Manzil</div>
              <div id="placeName" class="ptime" style="color:var(--text)">‚Äî</div>
            </div>
            <div style="margin-top:8px" class="hint">Agar GPS ishlamasa, sayt avtomatik Toshkentni tanlaydi.</div>
          </div>
        </div>
      </div>

      <div id="errorBox" style="display:none;margin-top:12px;padding:10px;border-radius:10px;background:rgba(255,0,0,0.04);color:#ffd0d0"></div>
      <footer>¬© IMBA Namoz v2 ‚Äî Asr = 16:11 (qo ªlda ustunlik)</footer>
    </div>
  </div>

<script>
/* ====== Konfiguratsiya ====== */
const TASHKENT = {lat:41.2995, lon:69.2401, name: "Toshkent, O'zbekiston"}
const AZAN_URL = 'https://cdn.pixabay.com/download/audio/2021/08/09/audio_d6b0d0b5f1.mp3?filename=azan-1-6206.mp3' // klassik-ish
const ASR_FORCED = "16:11" // <-- ASR doim shu vaqtga o'rnatiladi

const names = {fajr:'Bomdod', sunrise:'Quyosh', dhuhr:'Peshin', asr:'Asr', maghrib:'Shom', isha:'Xufton'}
const order = ['fajr','sunrise','dhuhr','asr','maghrib','isha']

/* ====== DOM ====== */
const gpsBtn = document.getElementById('gpsBtn'), playAzanBtn = document.getElementById('playAzanBtn')
const locText = document.getElementById('locText'), hintText = document.getElementById('hintText'), placeName = document.getElementById('placeName')
const timesGrid = document.getElementById('timesGrid'), nextPanel = document.getElementById('nextPanel')
const countdownEl = document.getElementById('countdown'), nextTimeLabel = document.getElementById('nextTimeLabel')
const dateLabel = document.getElementById('dateLabel'), clockNow = document.getElementById('clockNow')
const azanSwitch = document.getElementById('azanSwitch'), themeToggle = document.getElementById('themeToggle'), errorBox = document.getElementById('errorBox')

/* ====== State ====== */
let coords = null, timesToday = null, countdownTimer = null
let azanEnabled = (localStorage.getItem('azanEnabled') === 'true') || false
let theme = localStorage.getItem('theme') || 'dark'
let azanAudio = new Audio(AZAN_URL); azanAudio.preload = 'auto'; azanAudio.volume = 0.95

/* ====== UI helpers ====== */
function setAzanUI(val){
  azanEnabled = !!val
  localStorage.setItem('azanEnabled', azanEnabled)
  azanSwitch.classList.toggle('on', azanEnabled)
  azanSwitch.querySelector('.knob').style.left = azanEnabled ? '22px' : '4px'
}
function setTheme(t){
  theme = t
  localStorage.setItem('theme', t)
  if(t === 'light') document.documentElement.setAttribute('data-theme','light')
  else document.documentElement.removeAttribute('data-theme')
  themeToggle.classList.toggle('on', t !== 'light')
  themeToggle.querySelector('.knob').style.left = (t !== 'light') ? '22px' : '4px'
}
setAzanUI(azanEnabled); setTheme(theme)

/* ====== Small utilities ====== */
function showError(msg){ errorBox.style.display='block'; errorBox.textContent = msg }
function clearError(){ errorBox.style.display='none'; errorBox.textContent = '' }
function pad(n){ return n<10? '0'+n : ''+n }

/* ====== PrayTimes (compact) ====== */
(function(){
  function toRad(d){return d*Math.PI/180}
  function toDeg(d){return d*180/Math.PI}
  function fixAngle(a){return a - 360*Math.floor(a/360)}
  function jd(y,m,d){ if(m<=2){y-=1;m+=12} var A=Math.floor(y/100), B=2-A+Math.floor(A/4); return Math.floor(365.25*(y+4716))+Math.floor(30.6001*(m+1))+d+B-1524.5 }
  function sunPos(jd_){ var D=jd_-2451545.0; var g=fixAngle(357.529+0.98560028*D); var q=fixAngle(280.459+0.98564736*D); var L=fixAngle(q+1.915*Math.sin(toRad(g))+0.020*Math.sin(toRad(2*g))); var e=23.439-0.00000036*D; var RA=toDeg(Math.atan2(Math.cos(toRad(e))*Math.sin(toRad(L)),Math.cos(toRad(L))))/15; var decl=toDeg(Math.asin(Math.sin(toRad(e))*Math.sin(toRad(L)))); var eqt=q/15-RA; return {decl:decl, eqt:eqt} }
  function hourAngle(h,lat,decl){ var t=(Math.sin(toRad(h))-Math.sin(toRad(lat))*Math.sin(toRad(decl)))/(Math.cos(toRad(lat))*Math.cos(toRad(decl))); t=Math.max(-1,Math.min(1,t)); return toDeg(Math.acos(t))/15 }
  function toTimeStr(t){ t=(t+24)%24; var h=Math.floor(t); var m=Math.floor((t-h)*60+0.5); if(m>=60){h=(h+1)%24;m=0} return (h<10?'0'+h:h)+':'+(m<10?'0'+m:m) }
  window.PR = {
    times: function(dt, lat, lon){
      var y=dt.getFullYear(), m=dt.getMonth()+1, d=dt.getDate()
      var J=jd(y,m,d), sp=sunPos(J)
      var zone = -dt.getTimezoneOffset()/60
      var noon = 12 - sp.eqt - lon/15 + zone
      var fajrH = hourAngle(-18, lat, sp.decl)
      var sunriseH = hourAngle(-0.833, lat, sp.decl)
      var asrH = 1.0
      var fajr = noon - fajrH
      var sunrise = noon - sunriseH
      var dhuhr = noon
      var asr = noon + asrH
      var maghrib = noon + sunriseH
      var isha = noon + hourAngle(-17, lat, sp.decl)
      return {
        fajr: toTimeStr(fajr),
        sunrise: toTimeStr(sunrise),
        dhuhr: toTimeStr(dhuhr),
        asr: toTimeStr(asr),
        maghrib: toTimeStr(maghrib),
        isha: toTimeStr(isha)
      }
    }
  }
})();

/* ====== Render funksiyalari ====== */
function buildCards(times){
  timesGrid.innerHTML = ''
  const colors = [
    ['linear-gradient(135deg,#1f3b8b,#00d4b6)','‚òÄÔ∏è'],
    ['linear-gradient(135deg,#7b2ff7,#ff6fd8)','üåÖ'],
    ['linear-gradient(135deg,#ff9a00,#ff6a6a)','üåû'],
    ['linear-gradient(135deg,#00c6ff,#0072ff)','üåô'],
    ['linear-gradient(135deg,#12c2e9,#c471ed)','üåá'],
    ['linear-gradient(135deg,#00d4b6,#0077b6)','üïå']
  ]
  order.forEach((k,i)=>{
    const card = document.createElement('div'); card.className = 'prayer-card'
    const ic = document.createElement('div'); ic.className='icon'; ic.style.background = colors[i%colors.length][0]; ic.innerHTML = `<span style="font-size:18px">${colors[i%colors.length][1]}</span>`
    const txt = document.createElement('div'); txt.style.flex='1'
    const pname = document.createElement('div'); pname.className='pname'; pname.textContent = names[k]
    const ptime = document.createElement('div'); ptime.className='ptime'; ptime.style.fontSize='18px'
    // show seconds too: compute local today time with seconds = 00
    const t = times[k] // hh:mm
    ptime.textContent = t + ':00'
    txt.appendChild(pname); txt.appendChild(ptime)
    card.appendChild(ic); card.appendChild(txt)
    timesGrid.appendChild(card)
  })
  timesGrid.style.display = 'grid'
  nextPanel.style.display = 'flex'
}

/* ====== Real-time clock ====== */
function startClock(){
  setInterval(()=>{
    const now = new Date()
    clockNow.textContent = now.toLocaleTimeString('uz-UZ',{hour:'2-digit',minute:'2-digit',second:'2-digit'})
    dateLabel.textContent = now.toLocaleDateString('uz-UZ',{weekday:'long',day:'numeric',month:'long',year:'numeric'})
  },1000)
}

/* ====== Countdown (next prayer) ====== */
function startCountdown(times){
  if(countdownTimer) clearInterval(countdownTimer)
  function findNext(){
    const now = new Date()
    for(const k of order){
      let [hh,mm] = times[k].split(':').map(Number)
      // override asr to forced value for target computation
      if(k === 'asr'){
        const [H,M] = ASR_FORCED.split(':').map(Number)
        hh = H; mm = M
      }
      const t = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0)
      if(t > now) return {key:k, target:t}
    }
    // if none left => next day fajr (fajr uses computed time)
    const [hh,mm] = times['fajr'].split(':').map(Number)
    const t = new Date(now.getFullYear(), now.getMonth(), now.getDate()+1, hh, mm, 0)
    return {key:'fajr', target:t}
  }

  function tick(){
    const {key, target} = findNext()
    const now = new Date()
    let diff = Math.max(0, Math.floor((target - now)/1000))
    const hrs = Math.floor(diff/3600); diff -= hrs*3600
    const mins = Math.floor(diff/60); const secs = diff % 60
    countdownEl.textContent = `${names[key]}gacha: ${hrs} soat ${mins} daqiqa ${secs} soniya`
    nextTimeLabel.textContent = `${names[key]} ‚Äî ${target.toLocaleTimeString('uz-UZ',{hour:'2-digit',minute:'2-digit'})}`
    if((target - now) <= 0){
      // at exact time: play azan if enabled (may be blocked if no user gesture)
      if(azanEnabled){
        azanAudio.play().catch(e=>console.warn('Autoplay bloklandi:', e))
      }
      // recompute times (next day)
      if(coords) computeAndRender(coords.lat, coords.lon)
    }
  }
  tick()
  countdownTimer = setInterval(tick,1000)
}

/* ====== Compute and render (with ASR override) ====== */
async function computeAndRender(lat, lon){
  clearError()
  coords = {lat, lon}
  placeName.textContent = `${lat.toFixed(4)}, ${lon.toFixed(4)}`
  locText.textContent = `Kenglik: ${lat.toFixed(4)}, Uzunlik: ${lon.toFixed(4)}`
  hintText.textContent = 'Vaqtlar hisoblanmoqda...'
  try{
    const t = PR.times(new Date(), lat, lon)
    // override Asr to forced time
    t['asr'] = ASR_FORCED
    timesToday = t
    buildCards(t)
    startCountdown(t)
    hintText.textContent = 'Namoz vaqtlari hisoblandi (Asr doim 16:11).'
  }catch(e){
    showError('Hisoblashda xato: ' + (e.message||e))
  }
}

/* ====== Reverse geocode (best-effort) ====== */
async function tryReverseGeocode(lat, lon){
  try{
    const res = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lon}&localityLanguage=uz`)
    if(res.ok){
      const j = await res.json()
      placeName.textContent = j.city || j.locality || `${lat.toFixed(4)}, ${lon.toFixed(4)}`
    }
  }catch(e){ /* ignore */ }
}

/* ====== Geolocation logic (with automatic Toshkent fallback) ====== */
async function tryGeolocation(autoFallback=true){
  clearError()
  hintText.textContent = 'GPS so‚Äòrovi yuborildi ‚Äî brauzer ruxsatini bering...'
  // permissions check (best-effort)
  if(navigator.permissions){
    try{
      const p = await navigator.permissions.query({name:'geolocation'})
      if(p.state === 'denied'){
        showError('Joylashuvga ruxsat berilmagan ‚Äî avtomatik Toshkent fallback ishlaydi.')
        if(autoFallback) { useFallback(); return }
      }
    }catch(e){ /* continue */ }
  }
  if(!navigator.geolocation){
    showError('Brauzer geolokatsiyani qo‚Äòllab-quvvatlamaydi ‚Äî Toshkent fallback ishlaydi.')
    if(autoFallback) useFallback()
    return
  }
  navigator.geolocation.getCurrentPosition(async pos => {
    const lat = pos.coords.latitude, lon = pos.coords.longitude
    await tryReverseGeocode(lat, lon)
    computeAndRender(lat, lon)
  }, err => {
    let msg = ''
    switch(err.code){
      case 1: msg = 'Foydalanuvchi ruxsat bermadi. Toshkent fallback ishga tushirildi.'; break;
      case 2: msg = 'Joylashuv topilmadi. Toshkent fallback ishga tushirildi.'; break;
      case 3: msg = 'So‚Äòrov vaqt tugadi. Toshkent fallback ishga tushirildi.'; break;
      default: msg = 'Geolokatsiya xatosi: ' + (err.message || err.code)
    }
    showError(msg)
    if(autoFallback) useFallback()
  }, {enableHighAccuracy:true, timeout:15000, maximumAge:60000})
}

/* ====== Fallback: Toshkent ====== */
function useFallback(){
  const {lat, lon, name} = TASHKENT
  placeName.textContent = name
  computeAndRender(lat, lon)
}

/* ====== Event wiring ====== */
gpsBtn.addEventListener('click', ()=>{ tryGeolocation(true) })
playAzanBtn.addEventListener('click', async ()=>{
  try{
    await azanAudio.play()
  }catch(e){
    showError('Audio ijro etib bo‚Äòlmadi. Brauzer avtomatik ijroni bloklashi mumkin ‚Äî sahifada biror joyni bosib qayta urinib ko‚Äòring.')
  }
})
azanSwitch.addEventListener('click', ()=>{ setAzanUI(!azanEnabled) })
themeToggle.addEventListener('click', ()=>{ setTheme(theme === 'dark' ? 'light' : 'dark') })

/* ====== Init on load ====== */
window.addEventListener('load', ()=>{
  // small delay then try geolocation automatically
  setTimeout(()=>{ tryGeolocation(true) }, 500)
  // start clock
  setInterval(()=>{
    const now = new Date()
    clockNow.textContent = now.toLocaleTimeString('uz-UZ',{hour:'2-digit',minute:'2-digit',second:'2-digit'})
    dateLabel.textContent = now.toLocaleDateString('uz-UZ',{weekday:'long',day:'numeric',month:'long',year:'numeric'})
  },1000)
})

/* ====== helpers ====== */
function showError(msg){ errorBox.style.display='block'; errorBox.textContent = msg }
function clearError(){ errorBox.style.display='none'; errorBox.textContent = '' }

</script>
</body>
</html>
